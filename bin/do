#!/usr/bin/env node
'use strict'
const { collect, parseRaw } = require('../collecter')
const path = require('path')

const options = process.env.HOSTING_CONF
  ? require(process.env.HOSTING_CONF) : require(path.join(__dirname, '../hosting.json'))
const hostingList = Object.keys(options)
let rawOption = false

// accountlist start fromm
let idItr = 2
for (const arg of process.argv.slice(2)) {
  if (arg.startsWith('--')) {
    // help option
    if (arg.slice(2) === 'help') {
      console.log(`
Usage:

$ pubkey-collecter --<Options> [HostingService]:<account> ...
      Options:
        help                            show usage
        (github|gitlab|custom-service)  search as default
        raw                             Raw string output (useful for getting authorized_keys)

e.g.) pubkey-collecter --github --raw mkontani gitlab:niconico-pun      
      `)
      process.exit(1)
    }
    // raw option
    if (arg.slice(2) === 'raw') rawOption = true
    // hosting options
    else {
      const i = hostingList.indexOf(arg.slice(2))
      if (i > 0) options[hostingList[i]].default = true
    }
    idItr++
  } else break
}

collect(process.argv.slice(idItr), options).then(res => {
  if (rawOption) console.log(parseRaw(res))
  else console.log(res)
})
